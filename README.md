# PBX Control Portal MVP

Backend-only PBX control portal for Asterisk 22.7.0 (PJSIP-only).

## Features

- Create users with automatic SIP extension allocation (1000-1999)
- Apply configuration changes to Asterisk server
- List all users and their extensions
- Delete users and free their extensions

## Prerequisites

- Python 3.11 or higher
- PostgreSQL database at 77.42.28.222
- Asterisk 22.7.0 running locally on same host (65.108.92.238)

## Quick Start

### 1. Clone and Setup

```bash
git clone <repository-url>
cd PBX_Client_Web
```

### 2. Install Dependencies

```bash
python3.11 -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate
pip install -r requirements.txt
```

### 3. Configure Environment

```bash
cp .env.example .env
# Edit .env with your database credentials
```

### 4. Initialize Database

```bash
alembic upgrade head
```

### 5. Start Server

```bash
uvicorn src.main:app --reload --host 0.0.0.0 --port 8000
```

### 6. Access API Documentation

Open browser: http://localhost:8000/docs

## API Endpoints

- `POST /users` - Create user with auto-allocated extension
- `GET /users` - List all users
- `DELETE /users/{userId}` - Delete user
- `POST /apply` - Apply configuration to Asterisk
- `GET /health` - Health check endpoint

## Testing the MVP

### Step 1: Verify Health

```bash
curl http://localhost:8000/health
```

Expected response:
```json
{
  "status": "healthy",
  "service": "PBX Control Portal",
  "version": "1.0.0"
}
```

### Step 2: Create Users

```bash
# Create first user
curl -X POST http://localhost:8000/users \
  -H "Content-Type: application/json" \
  -d '{
    "name": "John Doe",
    "email": "john.doe@example.com"
  }'
```

Expected response (extension 1000):
```json
{
  "id": "123e4567-e89b-12d3-a456-426614174000",
  "tenant_id": "a0000000-0000-0000-0000-000000000000",
  "name": "John Doe",
  "email": "john.doe@example.com",
  "created_at": "2024-01-15T10:30:00",
  "extension": {
    "id": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
    "number": 1000,
    "secret": "a8K3mP9xQ2vR7wN5",
    "created_at": "2024-01-15T10:30:00"
  }
}
```

```bash
# Create second user
curl -X POST http://localhost:8000/users \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Jane Smith",
    "email": "jane.smith@example.com"
  }'
```

Expected response (extension 1001):
```json
{
  "extension": {
    "number": 1001,
    ...
  }
}
```

### Step 3: List Users

```bash
curl http://localhost:8000/users
```

Expected response:
```json
{
  "users": [
    {
      "id": "...",
      "name": "John Doe",
      "email": "john.doe@example.com",
      "extension": {
        "number": 1000,
        "secret": "..."
      }
    },
    {
      "id": "...",
      "name": "Jane Smith",
      "email": "jane.smith@example.com",
      "extension": {
        "number": 1001,
        "secret": "..."
      }
    }
  ]
}
```

### Step 4: Apply Configuration to Asterisk

```bash
curl -X POST http://localhost:8000/apply \
  -H "Content-Type: application/json" \
  -d '{
    "triggered_by": "admin@example.com"
  }'
```

Expected response:
```json
{
  "message": "Configuration applied successfully",
  "audit_log_id": "9b7d8c6e-5f4a-3b2c-1d0e-9f8a7b6c5d4e",
  "files_written": [
    "/etc/asterisk/pjsip.d/synergycall/generated_endpoints.conf",
    "/etc/asterisk/extensions.d/synergycall/generated_routing.conf"
  ],
  "reload_results": {
    "pjsip": {
      "command": "asterisk -rx module reload res_pjsip.so",
      "exit_code": 0,
      "stdout": "PJSIP reloaded",
      "stderr": "",
      "success": true
    },
    "dialplan": {
      "command": "asterisk -rx dialplan reload",
      "exit_code": 0,
      "stdout": "Dialplan reloaded",
      "stderr": "",
      "success": true
    }
  },
  "users_applied": 2,
  "extensions_generated": 2
}
```

### Step 5: Verify Generated Configurations

```bash
# Check PJSIP endpoints configuration
cat /etc/asterisk/pjsip.d/synergycall/generated_endpoints.conf
```

Expected output:
```ini
; PJSIP Endpoints - Auto-generated by PBX Control Portal
; DO NOT EDIT MANUALLY

[1000](!)
type=endpoint
context=synergy-internal
disallow=all
allow=ulaw
allow=alaw
auth=1000
aors=1000

[1000](!)
type=auth
auth_type=userpass
username=1000
password=a8K3mP9xQ2vR7wN5

[1000](!)
type=aor
max_contacts=3
remove_existing=yes

[1001](!)
type=endpoint
...
```

```bash
# Check dialplan configuration
cat /etc/asterisk/extensions.d/synergycall/generated_routing.conf
```

Expected output:
```ini
; Dialplan - Auto-generated by PBX Control Portal

[synergy-internal]
; Internal extension-to-extension dialing
exten => 1000,1,Dial(PJSIP/1000,20)
exten => 1000,n,Hangup()

exten => 1001,1,Dial(PJSIP/1001,20)
exten => 1001,n,Hangup()
```

### Step 6: Delete User

```bash
# Get user ID from list response, then delete
curl -X DELETE http://localhost:8000/users/{user_id}
```

Expected response:
```json
{
  "message": "User deleted successfully",
  "deleted_user_id": "123e4567-e89b-12d3-a456-426614174000",
  "freed_extension": 1000
}
```

### Step 7: Test Error Handling

```bash
# Try duplicate email
curl -X POST http://localhost:8000/users \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Duplicate",
    "email": "john.doe@example.com"
  }'
```

Expected response (409 Conflict):
```json
{
  "detail": {
    "error": "Email 'john.doe@example.com' is already in use",
    "details": null
  }
}
```

```bash
# Try concurrent apply operations
curl -X POST http://localhost:8000/apply -d '{"triggered_by": "admin1"}' &
curl -X POST http://localhost:8000/apply -d '{"triggered_by": "admin2"}'
```

Expected: One succeeds (200), one fails with lock conflict (409)

## Architecture

- **FastAPI**: REST API framework
- **SQLAlchemy**: ORM for PostgreSQL
- **Alembic**: Database migrations
- **subprocess**: Local Asterisk command execution

## Development

Run tests:
```bash
pytest tests/ -v
```

## License

Proprietary - PBX Control Portal Team
